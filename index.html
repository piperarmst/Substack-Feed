<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Zanskar Feed – Blog/News/Press Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#333; --muted:#777; --pill:#404040; --pillActive:#808080; --card:#fff; --line:#eee; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
           margin:2rem; color:var(--ink); background:#fff; }
    .filters { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.25rem; }
    .filters button { padding:.5rem .85rem; border:none; border-radius:999px; background:var(--pill); color:#fff; cursor:pointer; font-size:.95rem; }
    .filters button.active { background:var(--pillActive); }
    #feed { display:grid; gap:2rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
    .post { background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.05); transition:box-shadow .2s ease; }
    .post:hover { box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .post img { width:100%; height:180px; object-fit:cover; display:block; }
    .noimg { height:180px; background:#f3f3f3; color:#9a9a9a; display:flex; align-items:center; justify-content:center; font-size:.9rem; }
    .post-content { padding:1rem; }
    .post-title { font-weight:700; font-size:1rem; margin:0 0 .5rem; }
    .post-title a { color:var(--ink); text-decoration:none; }
    .post-title a:hover { text-decoration:underline; }
    .post-date { font-size:.85rem; color:var(--muted); }
    .tagline { margin:.25rem 0 0; font-size:.8rem; color:var(--muted); }
    .empty,.error { color:var(--muted); font-size:1rem; grid-column:1/-1; }
  </style>
</head>
<body>
  <div class="filters">
    <button data-filter="__all__" class="active">All</button>
    <button data-filter="blog">Blog</button>
    <button data-filter="news">News</button>
    <button data-filter="press">Press</button>
  </div>

  <div id="feed">Loading posts...</div>

  <script>
    // ---------- CONFIG ----------
    const imageMap = {
      // "Exact Post Title": "https://your-cdn.com/image.jpg",
    };
    const FEED_BASE = "https://zanskargeothermal.substack.com/feed";
    // Bust rss2json cache so new tags appear promptly
    const FEED_URL =
      "https://api.rss2json.com/v1/api.json?rss_url=" +
      encodeURIComponent(`${FEED_BASE}?ts=${Date.now()}`);

    // ---------- HELPERS ----------
    const norm = s => (s || "").trim().toLowerCase();

    // Canonicalize variants to our fixed filters
    const CANON = tag => {
      const t = norm(tag);
      if (!t) return "";
      if (t.startsWith("press")) return "press";
      if (t === "press release" || t === "press releases") return "press";
      if (t === "blog" || t === "article" || t === "posts") return "blog";
      if (t === "news" || t === "updates" || t === "update") return "news";
      return t; // keep unexpected tags for display; they just won’t match buttons
    };

    const inferFromTitle = title => {
      const m = (title || "").match(/^(blog|news|press)\s*:/i);
      return m ? m[1].toLowerCase() : "";
    };

    // Grab any tags from multiple places rss2json/substack might expose
    function extractAllTags(item) {
      let raw = [];
      // 1) Normal rss2json field
      if (Array.isArray(item.categories)) raw = raw.concat(item.categories);
      // 2) Some feeds use category singular
      if (Array.isArray(item.category)) raw = raw.concat(item.category);
      else if (typeof item.category === "string") raw.push(item.category);
      // 3) Rare 'tags' field
      if (Array.isArray(item.tags)) raw = raw.concat(item.tags);

      // 4) Parse from HTML description: <a rel="tag">…</a> or href contains /tag/ or /tags/
      try {
        if (item.description) {
          const tmp = document.createElement("div");
          tmp.innerHTML = item.description;
          const anchors = tmp.querySelectorAll('a[rel="tag"], a[href*="/tag/"], a[href*="/tags/"]');
          anchors.forEach(a => {
            const text = a.textContent || "";
            if (text.trim()) raw.push(text.trim());
          });
        }
      } catch (_) {}

      // Clean and de-dupe
      const cleaned = [];
      const seen = new Set();
      raw.forEach(t => {
        const val = (t || "").toString().trim();
        if (val && !seen.has(val.toLowerCase())) {
          seen.add(val.toLowerCase());
          cleaned.push(val);
        }
      });
      return cleaned;
    }

    async function fetchRSS() {
      const feedEl = document.getElementById("feed");
      try {
        const res = await fetch(FEED_URL);
        const data = await res.json();

        if (data.status !== "ok") {
          feedEl.innerHTML = `<div class="error">Couldn’t load posts (rss2json: ${data.message || "error"}). Try again shortly.</div>`;
          return;
        }

        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length) {
          feedEl.innerHTML = `<div class="empty">No posts found. Ensure at least one post is public.</div>`;
          return;
        }

        feedEl.innerHTML = "";

        items.forEach(item => {
          const title = item.title || "";
          const link = item.link;
          const dateStr = item.pubDate
            ? new Date(item.pubDate).toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" })
            : "";

          // Tags from all sources
          let rawTags = extractAllTags(item);
          let canonTags = rawTags.map(CANON).filter(Boolean);

          // If nothing came through, infer from title prefix
          if (!canonTags.length) {
            const inferred = inferFromTitle(title);
            if (inferred) canonTags = [inferred];
          }

          const datasetTags = canonTags.map(norm).join(",");

          // Image: thumbnail → first <img> in description → manual map
          let imageURL = item.thumbnail || "";
          if (!imageURL && item.description) {
            const tmp = document.createElement("div");
            tmp.innerHTML = item.description;
            const imgEl = tmp.querySelector("img");
            if (imgEl && imgEl.src) imageURL = imgEl.src;
          }
          if (!imageURL && imageMap[title]) imageURL = imageMap[title];

          const card = document.createElement("div");
          card.className = "post";
          card.dataset.tags = datasetTags;

          // Show human-friendly tags under the card: prefer original if present, else canonical/inferred
          const displayTags = rawTags.length ? rawTags : canonTags;

          card.innerHTML = `
            ${imageURL ? `<img src="${imageURL}" alt="">` : `<div class="noimg">No Image</div>`}
            <div class="post-content">
              <div class="post-title"><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></div>
              <div class="post-date">${dateStr}</div>
              ${displayTags.length ? `<div class="tagline">Tags: ${displayTags.join(", ")}</div>` : ``}
            </div>
          `;

          feedEl.appendChild(card);
        });

        // Apply whichever filter is active
        const active = document.querySelector(".filters button.active")?.dataset.filter || "__all__";
        applyFilter(active);

      } catch (e) {
        console.error(e);
        document.getElementById("feed").innerHTML = `<div class="error">Network error loading the feed. Please try again.</div>`;
      }
    }

    function applyFilter(tag) {
      const posts = Array.from(document.querySelectorAll(".post"));
      const wrap = document.getElementById("feed");
      const prior = wrap.querySelector(".empty-row");
      if (prior) prior.remove();

      if (tag === "__all__") {
        posts.forEach(p => p.style.display = "");
        return;
      }

      const selected = norm(tag);
      let shown = 0;
      posts.forEach(p => {
        const tags = p.dataset.tags.split(",").filter(Boolean);
        const match = tags.includes(selected);
        p.style.display = match ? "" : "none";
        if (match) shown++;
      });

      if (!shown) {
        const msg = document.createElement("div");
        msg.className = "empty empty-row";
        msg.textContent = `No posts tagged “${tag}” yet.`;
        wrap.appendChild(msg);
      }
    }

    document.querySelectorAll(".filters button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        applyFilter(btn.dataset.filter);
      });
    });

    fetchRSS();
  </script>
</body>
</html>
