<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Zanskar Feed – Blog/News/Press Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#333; --muted:#777; --pill:#404040; --pillActive:#808080; --card:#fff; --line:#eee; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
           margin:2rem; color:var(--ink); background:#fff; }
    .filters { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.25rem; }
    .filters button { padding:.5rem .85rem; border:none; border-radius:999px; background:var(--pill); color:#fff; cursor:pointer; font-size:.95rem; }
    .filters button.active { background:var(--pillActive); }
    #feed { display:grid; gap:2rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
    .post { background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden;
            box-shadow:0 2px 6px rgba(0,0,0,.05); transition:box-shadow .2s ease; }
    .post:hover { box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .post img { width:100%; height:180px; object-fit:cover; display:block; }
    .noimg { height:180px; background:#f3f3f3; color:#9a9a9a; display:flex; align-items:center; justify-content:center; font-size:.9rem; }
    .post-content { padding:1rem; }
    .post-title { font-weight:700; font-size:1rem; margin:0 0 .5rem; }
    .post-title a { color:var(--ink); text-decoration:none; }
    .post-title a:hover { text-decoration:underline; }
    .post-date { font-size:.85rem; color:var(--muted); }
    .status { grid-column:1/-1; color:var(--muted); }
  </style>
</head>
<body>
  <div class="filters">
    <button data-filter="__all__" class="active">All</button>
    <button data-filter="blog">Blog</button>
    <button data-filter="news">News</button>
    <button data-filter="press">Press</button>
  </div>

  <div id="feed">Loading posts...</div>

  <script>
    // ===== CONFIG =====
    const PUB = "https://zanskargeothermal.substack.com";

    // Auto-refresh cadence: change to 1, 5, 10 (minutes) as you like
    const BUCKET_MINUTES = 5;
    // This value only changes every BUCKET_MINUTES, forcing rss2json to re-fetch
    const TS_BUCKET = Math.floor(Date.now() / (BUCKET_MINUTES * 60 * 1000));

    // Optional manual image overrides (exact post title -> image URL)
    const imageMap = {
      // "Exact Post Title": "https://your-cdn.com/image.jpg",
    };

    // ===== FEED HELPERS =====
    // Candidate tag-feed URL patterns (Substack supports at least one of these)
    function tagFeedUrls(slug) {
      return [
        `${PUB}/feed?tag=${encodeURIComponent(slug)}`,
        `${PUB}/feed/tag/${encodeURIComponent(slug)}`,
        `${PUB}/t/${encodeURIComponent(slug)}?format=rss`,
      ];
    }

    // Base (All) feed
    function baseFeedUrls() {
      return [ `${PUB}/feed` ];
    }

    // Wrap a Substack RSS URL in rss2json and include the *bucketed* ts
    function rss2jsonUrl(rssUrl) {
      // Put ts INSIDE the rss_url so rss2json cache is busted
      const bust = rssUrl.includes("?") ? `${rssUrl}&ts=${TS_BUCKET}` : `${rssUrl}?ts=${TS_BUCKET}`;
      return "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(bust);
    }

    // ===== CACHE =====
    // Simple in-memory cache so switching filters is instant
    const cache = new Map(); // key -> items[]

    async function fetchItemsFor(key, rssUrlCandidates) {
      if (cache.has(key)) return cache.get(key);

      for (const rss of rssUrlCandidates) {
        try {
          const url = rss2jsonUrl(rss);
          const res = await fetch(url);
          const data = await res.json();
          if (data.status === "ok" && Array.isArray(data.items)) {
            // Even an empty array is valid; but prefer first source with >0 items
            if (data.items.length) {
              cache.set(key, data.items);
              return data.items;
            }
            // Keep trying other candidates if empty
          }
        } catch (e) {
          // Try next candidate
          console.warn("Feed try failed:", rss, e);
        }
      }
      // If none worked (or all empty), cache empty so we don't spam requests
      cache.set(key, []);
      return [];
    }

    // ===== RENDER =====
    function renderItems(items) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = "";

      if (!items.length) {
        feedEl.innerHTML = `<div class="status">No posts found for this filter yet.</div>`;
        return;
      }

      items.forEach(item => {
        const title = item.title || "";
        const link = item.link;
        const dateStr = item.pubDate
          ? new Date(item.pubDate).toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" })
          : "";

        // Image: thumbnail → first <img> in description → manual map
        let imageURL = item.thumbnail || "";
        if (!imageURL && item.description) {
          const tmp = document.createElement("div");
          tmp.innerHTML = item.description;
          const imgEl = tmp.querySelector("img");
          if (imgEl && imgEl.src) imageURL = imgEl.src;
        }
        if (!imageURL && imageMap[title]) imageURL = imageMap[title];

        const card = document.createElement("div");
        card.className = "post";
        card.innerHTML = `
          ${imageURL ? `<img src="${imageURL}" alt="">` : `<div class="noimg">No Image</div>`}
          <div class="post-content">
            <div class="post-title"><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></div>
            <div class="post-date">${dateStr}</div>
          </div>
        `;
        feedEl.appendChild(card);
      });
    }

    async function loadFilter(filter) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = `<div class="status">Loading…</div>`;

      let key, urls;
      if (filter === "__all__") {
        key = "all";
        urls = baseFeedUrls();
      } else {
        key = `tag:${filter}`;
        const slug = filter; // e.g., "blog", "news", "press"; change here if your slugs differ
        urls = tagFeedUrls(slug);
      }

      const items = await fetchItemsFor(key, urls);
      renderItems(items);
    }

    // Wire up the fixed buttons
    document.querySelectorAll(".filters button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        loadFilter(btn.dataset.filter);
      });
    });

    // Initial load
    loadFilter("__all__");
  </script>
</body>
</html>
