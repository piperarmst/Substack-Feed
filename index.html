<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Zanskar Feed – Blog/News/Press Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#333; --muted:#777; --pill:#404040; --pillActive:#808080; --card:#fff; --line:#eee; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
           margin:2rem; color:var(--ink); background:#fff; }
    .filters { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.25rem; }
    .filters button { padding:.5rem .85rem; border:none; border-radius:999px; background:var(--pill); color:#fff; cursor:pointer; font-size:.95rem; }
    .filters button.active { background:var(--pillActive); }
    #feed { display:grid; gap:2rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
    .post { background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden;
            box-shadow:0 2px 6px rgba(0,0,0,.05); transition:box-shadow .2s ease; }
    .post:hover { box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .post img { width:100%; height:180px; object-fit:cover; display:block; }
    .noimg { height:180px; background:#f3f3f3; color:#9a9a9a; display:flex; align-items:center; justify-content:center; font-size:.9rem; }
    .post-content { padding:1rem; }
    .post-title { font-weight:700; font-size:1rem; margin:0 0 .5rem; }
    .post-title a { color:var(--ink); text-decoration:none; }
    .post-title a:hover { text-decoration:underline; }
    .post-date { font-size:.85rem; color:var(--muted); }
    .status { grid-column:1/-1; color:var(--muted); }
  </style>
</head>
<body>
  <div class="filters">
    <button data-filter="__all__" class="active">All</button>
    <button data-filter="blog">Blog</button>
    <button data-filter="news">News</button>
    <button data-filter="press">Press</button>
  </div>

  <div id="feed">Loading posts...</div>

  <script>
    // ------- CONFIG -------
    const PUB = "https://zanskargeothermal.substack.com";
    // Optional manual image overrides (exact post title -> image URL)
    const imageMap = {
      // "Exact Post Title": "https://your-cdn.com/image.jpg",
    };

    // Candidate tag-feed URL patterns (most Substacks respond to one of these)
    function tagFeedUrls(slug) {
      return [
        `${PUB}/feed?tag=${encodeURIComponent(slug)}`,
        `${PUB}/feed/tag/${encodeURIComponent(slug)}`,
        `${PUB}/t/${encodeURIComponent(slug)}?format=rss`,
      ];
    }

    // Wrap a Substack RSS URL in rss2json + cache-buster so we always refresh
    function rss2jsonUrl(rssUrl) {
      const ts = Date.now();
      // include ts inside rss_url so rss2json cache is busted
      const bust = rssUrl.includes("?") ? `${rssUrl}&ts=${ts}` : `${rssUrl}?ts=${ts}`;
      return "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(bust);
    }

    // In-memory cache: { key -> items[] }
    const cache = new Map();

    // ------- FETCHERS -------
    async function fetchItemsFor(key, rssUrlCandidates) {
      // serve from cache if present
      if (cache.has(key)) return cache.get(key);

      for (const rss of rssUrlCandidates) {
        try {
          const url = rss2jsonUrl(rss);
          const res = await fetch(url);
          const data = await res.json();
          if (data.status === "ok" && Array.isArray(data.items) && data.items.length) {
            cache.set(key, data.items);
            return data.items;
          }
        } catch (e) {
          // try next candidate
          console.warn("tag feed try failed:", rss, e);
        }
      }
      // If none worked, cache empty to avoid spamming requests
      cache.set(key, []);
      return [];
    }

    // "All" uses the base feed
    function baseFeedUrls() {
      return [ `${PUB}/feed` ];
    }

    // ------- RENDER -------
    function renderItems(items) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = "";

      if (!items.length) {
        feedEl.innerHTML = `<div class="status">No posts found for this filter yet.</div>`;
        return;
      }

      items.forEach(item => {
        const title = item.title || "";
        const link = item.link;
        const dateStr = item.pubDate
          ? new Date(item.pubDate).toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" })
          : "";

        // Image: thumbnail → first <img> in description → manual map
        let imageURL = item.thumbnail || "";
        if (!imageURL && item.description) {
          const tmp = document.createElement("div");
          tmp.innerHTML = item.description;
          const imgEl = tmp.querySelector("img");
          if (imgEl && imgEl.src) imageURL = imgEl.src;
        }
        if (!imageURL && imageMap[title]) imageURL = imageMap[title];

        const card = document.createElement("div");
        card.className = "post";
        card.innerHTML = `
          ${imageURL ? `<img src="${imageURL}" alt="">` : `<div class="noimg">No Image</div>`}
          <div class="post-content">
            <div class="post-title"><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></div>
            <div class="post-date">${dateStr}</div>
          </div>
        `;
        document.getElementById("feed").appendChild(card);
      });
    }

    async function loadFilter(filter) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = `<div class="status">Loading…</div>`;

      let key = filter;
      let urls = [];

      if (filter === "__all__") {
        key = "all";
        urls = baseFeedUrls();
      } else {
        // map button label to slug; you can change these if your tag slugs differ
        const slug = filter; // "blog", "news", "press"
        urls = tagFeedUrls(slug);
      }

      const items = await fetchItemsFor(key, urls);
      renderItems(items);
    }

    // Wire up buttons
    document.querySelectorAll(".filters button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        loadFilter(btn.dataset.filter);
      });
    });

    // Initial load: All
    loadFilter("__all__");
  </script>
</body>
</html>
