<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zanskar Feed – Blog/News/Press Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#333; --muted:#777; --pill:#404040; --pillActive:#808080; --card:#fff; --line:#eee; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 2rem; color: var(--ink); background:#fff;
    }
    .filters { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.25rem; }
    .filters button {
      padding:.5rem .85rem; border:none; border-radius:999px; background:var(--pill);
      color:#fff; cursor:pointer; font-size:.95rem;
    }
    .filters button.active { background:var(--pillActive); }
    #feed { display:grid; gap:2rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
    .post {
      background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,.05); transition:box-shadow .2s ease;
    }
    .post:hover { box-shadow:0 4px 12px rgba(0,0,0,.1); }

    /* Desktop/Tablet */
    .post img { width:100%; height:180px; object-fit:cover; display:block; }
    .noimg {
      height:180px; background:#f3f3f3; color:#9a9a9a; display:flex; align-items:center; justify-content:center; font-size:.9rem;
    }

    .post-content { padding:1rem; }
    .post-title { font-weight:700; font-size:1rem; margin:0 0 .5rem; }
    .post-title a { color:var(--ink); text-decoration:none; }
    .post-title a:hover { text-decoration:underline; }
    .post-date { font-size:.85rem; color:var(--muted); }
    .status { grid-column:1/-1; color:var(--muted); }

    /* Mobile */
    @media (max-width: 640px) {
      #feed { grid-template-columns: 1fr; gap: 1rem; }
      .post img { height:auto; object-fit:contain; max-height:60vh; }
      .noimg { height:40vw; }
    }
  </style>
</head>
<body>
  <div class="filters">
    <button data-filter="__all__" class="active">All</button>
    <button data-filter="blog">Blog</button>
    <button data-filter="news">News</button>
    <button data-filter="press">Press</button>
  </div>

  <div id="feed">Loading posts...</div>

  <script>
    // ------------ CONFIG ------------
    const PUB = "https://zanskargeothermal.substack.com";
    // UI label -> actual Substack tag slug (you’re using /t/blogs and /t/news)
    const TAG_MAP = { blog: "blogs", news: "news", press: "press" };

    // Optional manual image overrides (exact post title -> image URL)
    const imageMap = {
      // "Exact Post Title": "https://your-cdn.com/image.jpg",
    };

    // CORS-safe proxy for fetching RSS XML
    const PROXY = "https://api.allorigins.win/raw?url=";

    // ------------ UTIL ------------
    const cache = new Map(); // key -> parsed items[]
    const proper = v => (v == null ? "" : String(v));

    const sortByDateDesc = items => [...items].sort(
      (a,b) => new Date(b.pubDate||0) - new Date(a.pubDate||0)
    );

    const dedupeByLink = items => {
      const seen = new Set(), out = [];
      for (const it of items) {
        const key = proper(it.link);
        if (!key || seen.has(key)) continue;
        seen.add(key); out.push(it);
      }
      return out;
    };

    function tagFeedCandidates(uiFilter) {
      const real = TAG_MAP[uiFilter] || uiFilter;
      const lc = real.toLowerCase();
      const tc = lc.charAt(0).toUpperCase() + lc.slice(1);
      return [
        `${PUB}/t/${lc}?format=rss`,
        `${PUB}/t/${tc}?format=rss`,
        `${PUB}/feed?tag=${encodeURIComponent(lc)}`,
        `${PUB}/feed?tag=${encodeURIComponent(tc)}`,
        `${PUB}/feed/tag/${encodeURIComponent(lc)}`,
        `${PUB}/feed/tag/${encodeURIComponent(tc)}`
      ];
    }

    function feedUrlWithBuster(url) {
      const ts = Date.now();
      return url.includes("?") ? `${url}&ts=${ts}` : `${url}?ts=${ts}`;
    }

    // ------------ RSS PARSER ------------
    async function fetchAndParseRssXML(key, urlCandidates) {
      if (cache.has(key)) return cache.get(key);

      for (const rssUrl of urlCandidates) {
        try {
          const target = feedUrlWithBuster(rssUrl);
          const proxied = PROXY + encodeURIComponent(target);
          const text = await fetch(proxied).then(r => {
            if (!r.ok) throw new Error("Fetch failed");
            return r.text();
          });

          const doc = new DOMParser().parseFromString(text, "application/xml");
          const items = Array.from(doc.querySelectorAll("item")).map(parseItemFromXML);

          if (items.length) {
            cache.set(key, items);
            return items;
          }
        } catch (e) {
          // try next candidate
        }
      }

      cache.set(key, []);
      return [];
    }

    function textContent(node, sel) {
      const el = node.querySelector(sel);
      return el ? el.textContent.trim() : "";
    }

    function parseItemFromXML(itemEl) {
      const title = textContent(itemEl, "title");
      const link = textContent(itemEl, "link");
      const pubDate = textContent(itemEl, "pubDate");

      // categories
      const categories = Array.from(itemEl.querySelectorAll("category")).map(x => x.textContent.trim());

      // image candidates
      let thumbnail = "";
      // enclosure tag
      const enclosure = itemEl.querySelector("enclosure[url]");
      if (enclosure) thumbnail = enclosure.getAttribute("url") || "";
      // media:content
      if (!thumbnail) {
        const media = itemEl.querySelector("media\\:content, content");
        if (media && media.getAttribute) {
          thumbnail = media.getAttribute("url") || "";
        }
      }
      // parse content:encoded or description for first <img>
      const contentHTML =
        textContent(itemEl, "content\\:encoded") ||
        textContent(itemEl, "content") ||
        textContent(itemEl, "description");

      let firstImg = "";
      if (contentHTML) {
        const div = document.createElement("div");
        div.innerHTML = contentHTML;
        const img = div.querySelector("img");
        if (img) firstImg = img.getAttribute("src") || img.getAttribute("data-src") || "";
      }

      const derivedThumb = thumbnail || firstImg || (imageMap[title] || "");

      return { title, link, pubDate, categories, thumbnail: derivedThumb, description: contentHTML };
    }

    function matchesCategory(item, uiFilter) {
      const real = (TAG_MAP[uiFilter] || uiFilter).toLowerCase();
      return (item.categories || []).some(c => proper(c).toLowerCase() === real);
    }

    // Base feed (All)
    function baseFeedUrls() { return [`${PUB}/feed`]; }

    // ------------ RENDER ------------
    function renderItems(items, wanted) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = "";

      if (!items.length) {
        const label = wanted === "__all__" ? "these filters" : `"${wanted}"`;
        feedEl.innerHTML = `<div class="status">No posts tagged ${label} yet.</div>`;
        return;
      }

      for (const item of items) {
        const title = item.title || "";
        const link = item.link;
        const dateStr = item.pubDate
          ? new Date(item.pubDate).toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" })
          : "";
        const imageURL = item.thumbnail || "";

        const card = document.createElement("div");
        card.className = "post";
        card.innerHTML = `
          ${imageURL ? `<img src="${imageURL}" alt="">` : `<div class="noimg">No Image</div>`}
          <div class="post-content">
            <div class="post-title"><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></div>
            <div class="post-date">${dateStr}</div>
          </div>
        `;
        feedEl.appendChild(card);
      }
    }

    // ------------ CONTROLLER ------------
    async function loadFilter(filter) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = `<div class="status">Loading…</div>`;

      try {
        if (filter === "__all__") {
          const items = await fetchAndParseRssXML("all", baseFeedUrls());
          renderItems(sortByDateDesc(items), filter);
          return;
        }

        // Try dedicated tag feeds first
        const candidates = tagFeedCandidates(filter);
        let items = await fetchAndParseRssXML(`tag:${filter}`, candidates);

        // Fallback to base feed filtering
        if (!items.length) {
          const all = await fetchAndParseRssXML("all", baseFeedUrls());
          items = all.filter(it => matchesCategory(it, filter));
        }

        items = dedupeByLink(sortByDateDesc(items));
        renderItems(items, filter);
      } catch (err) {
        feedEl.innerHTML = `<div class="status">Error loading feed. Please refresh.</div>`;
        // Optional: console error for debugging
        console.error(err);
      }
    }

    // Wire up buttons
    document.querySelectorAll(".filters button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        loadFilter(btn.dataset.filter);
      });
    });

    // Initial load
    loadFilter("__all__");
  </script>
</body>
</html>
