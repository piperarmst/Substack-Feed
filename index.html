<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Zanskar Feed – Blog/News/Press Filters</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#333; --muted:#777; --pill:#404040; --pillActive:#808080; --card:#fff; --line:#eee; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
           margin:2rem; color:var(--ink); background:#fff; }
    .filters { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1.25rem; }
    .filters button { padding:.5rem .85rem; border:none; border-radius:999px; background:var(--pill); color:#fff; cursor:pointer; font-size:.95rem; }
    .filters button.active { background:var(--pillActive); }
    #feed { display:grid; gap:2rem; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
    .post { background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden;
            box-shadow:0 2px 6px rgba(0,0,0,.05); transition:box-shadow .2s ease; }
    .post:hover { box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .post img { width:100%; height:180px; object-fit:cover; display:block; }
    .noimg { height:180px; background:#f3f3f3; color:#9a9a9a; display:flex; align-items:center; justify-content:center; font-size:.9rem; }
    .post-content { padding:1rem; }
    .post-title { font-weight:700; font-size:1rem; margin:0 0 .5rem; }
    .post-title a { color:var(--ink); text-decoration:none; }
    .post-title a:hover { text-decoration:underline; }
    .post-date { font-size:.85rem; color:var(--muted); }
    .status { grid-column:1/-1; color:var(--muted); }
  </style>
</head>
<body>
  <div class="filters">
    <button data-filter="__all__" class="active">All</button>
    <button data-filter="blog">Blog</button>
    <button data-filter="news">News</button>
    <button data-filter="press">Press</button>
  </div>

  <div id="feed">Loading posts...</div>

  <script>
    // ------- CONFIG -------
    const PUB = "https://zanskargeothermal.substack.com";

    // Map UI buttons -> real Substack tag/section slugs
    // You changed Blog -> Blogs, so we point "blog" to "blogs".
    // Add/keep "press" if/when the client creates it in Substack.
    const TAG_MAP = {
      blog:  "blogs",
      news:  "news",
      press: "press"
    };

    // Optional manual image overrides (exact post title -> image URL)
    const imageMap = {
      // "Exact Post Title": "https://your-cdn.com/image.jpg",
    };

    // Cache
    const cache = new Map(); // key -> items[]

    // Helpers
    const proper = s => s ? String(s) : "";
    const titleCase = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();

    function rss2jsonUrl(rssUrl) {
      const ts = Date.now();
      const bust = rssUrl.includes("?") ? `${rssUrl}&ts=${ts}` : `${rssUrl}?ts=${ts}`;
      return "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(bust);
    }

    function tagFeedCandidates(uiFilter) {
      // Resolve UI filter to the real slug
      const real = TAG_MAP[uiFilter] || uiFilter;
      const lc = real.toLowerCase();
      const tc = titleCase(real);
      // Try several patterns and both lowercase + TitleCase
      return [
        `${PUB}/t/${lc}?format=rss`,
        `${PUB}/t/${tc}?format=rss`,
        `${PUB}/feed?tag=${encodeURIComponent(lc)}`,
        `${PUB}/feed?tag=${encodeURIComponent(tc)}`,
        `${PUB}/feed/tag/${encodeURIComponent(lc)}`,
        `${PUB}/feed/tag/${encodeURIComponent(tc)}`
      ];
    }

    function sortByDateDesc(items) {
      return [...items].sort((a,b) => new Date(b.pubDate||0) - new Date(a.pubDate||0));
    }

    function dedupeByLink(items) {
      const seen = new Set();
      const out = [];
      for (const it of items) {
        const key = proper(it.link);
        if (!key || seen.has(key)) continue;
        seen.add(key);
        out.push(it);
      }
      return out;
    }

    async function fetchRssCandidates(key, candidates) {
      if (cache.has(key)) return cache.get(key);
      for (const rss of candidates) {
        try {
          const res = await fetch(rss2jsonUrl(rss));
          const data = await res.json();
          if (data.status === "ok" && Array.isArray(data.items) && data.items.length) {
            cache.set(key, data.items);
            return data.items;
          }
        } catch { /* try next */ }
      }
      cache.set(key, []);
      return [];
    }

    async function loadAllFeed() {
      return fetchRssCandidates("all", [`${PUB}/feed`]);
    }

    // If tag feeds are empty, as a fallback check item.categories
    function matchesCategory(item, uiFilter) {
      const real = TAG_MAP[uiFilter] || uiFilter;
      const cats = Array.isArray(item.categories) ? item.categories : [];
      const target = real.toLowerCase();
      return cats.some(c => proper(c).trim().toLowerCase() === target);
    }

    // ------- RENDER -------
    function renderItems(items, wanted) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = "";

      if (!items.length) {
        const label = wanted === "__all__" ? "these filters" : `"${wanted}"`;
        feedEl.innerHTML = `<div class="status">No posts tagged ${label} yet.</div>`;
        return;
      }

      for (const item of items) {
        const title = item.title || "";
        const link = item.link;
        const dateStr = item.pubDate
          ? new Date(item.pubDate).toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" })
          : "";

        let imageURL = item.thumbnail || "";
        if (!imageURL && item.description) {
          const tmp = document.createElement("div");
          tmp.innerHTML = item.description;
          const imgEl = tmp.querySelector("img");
          if (imgEl && imgEl.src) imageURL = imgEl.src;
        }
        if (!imageURL && imageMap[title]) imageURL = imageMap[title];

        const card = document.createElement("div");
        card.className = "post";
        card.innerHTML = `
          ${imageURL ? `<img src="${imageURL}" alt="">` : `<div class="noimg">No Image</div>`}
          <div class="post-content">
            <div class="post-title"><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></div>
            <div class="post-date">${dateStr}</div>
          </div>
        `;
        document.getElementById("feed").appendChild(card);
      }
    }

    // ------- LOAD PER FILTER -------
    async function loadFilter(filter) {
      const feedEl = document.getElementById("feed");
      feedEl.innerHTML = `<div class="status">Loading…</div>`;

      if (filter === "__all__") {
        const items = await loadAllFeed();
        renderItems(sortByDateDesc(items), filter);
        return;
      }

      // 1) Try the real tag/section feeds (e.g., /t/blogs, /t/news)
      const candidates = tagFeedCandidates(filter);
      let items = await fetchRssCandidates(`tag:${filter}`, candidates);

      // 2) Fallback: filter base feed by categories if tag feeds return nothing
      if (!items.length) {
        const all = await loadAllFeed();
        items = all.filter(it => matchesCategory(it, filter));
      }

      items = dedupeByLink(sortByDateDesc(items));
      renderItems(items, filter);
    }

    // Wire up buttons
    document.querySelectorAll(".filters button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        loadFilter(btn.dataset.filter);
      });
    });

    // Initial
    loadFilter("__all__");
  </script>
</body>
</html>
